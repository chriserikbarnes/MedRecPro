@using MedRecPro.Models;
@using MedRecPro.Helpers;
@inherits RazorLight.TemplatePage<MedRecPro.Models.AuthorRendering>;
@model AuthorRendering;

@* 
    Hierarchical author template with child organizations and business operations.
    Uses DocumentRelationshipIdentifier-based contextual filtering to ensure each
    hierarchy level displays only the identifiers that appeared at that level in
    the original SPL document, preserving perfect structural fidelity.
*@
<author>
    <time />
    <assignedEntity>
        <representedOrganization>
            @* 
                Render author organization identifiers if available.
                These are the identifiers at the top (author/labeler) level.
            *@
            @if (Model.HasAuthorIdentifiers)
            {
                foreach (var identifier in Model.AuthorIdentifiers)
                {
                    if (!string.IsNullOrWhiteSpace(identifier.IdentifierValue) &&
                    !string.IsNullOrWhiteSpace(identifier.IdentifierSystemOID))
                    {
                        <id @SplTemplateHelpers.Attribute("extension", identifier.IdentifierValue) @SplTemplateHelpers.Attribute("root", identifier.IdentifierSystemOID) />
                    }
                }
            }
            @* Author organization name *@
            <name>@Model.AuthorOrganizationName</name>
            @* Render child organizations if available *@
            @if (Model.HasChildOrganizations)
            {
                <assignedEntity>
                    <assignedOrganization>
                        @foreach (var childOrg in Model.ChildOrganizations)
                        {
                            <assignedEntity>
                                @* Render confidentiality code if organization is confidential *@
                                @if (childOrg.IsConfidential)
                                {
                                    <confidentialityCode code="B" codeSystem="2.16.840.1.113883.5.25" />
                                }
                                <assignedOrganization>
                                    @* 
                                        CRITICAL: Render contextually-filtered child organization identifiers.
                                        
                                        childOrg.OrganizationIdentifiers contains ONLY the identifiers that 
                                        appeared at THIS specific hierarchy level in the original SPL document.
                                        
                                        This is filtered using DocumentRelationshipIdentifier data by the
                                        AuthorRenderingService.filterContextualIdentifiers method, which ensures
                                        perfect structural fidelity to the source XML.
                                        
                                        Example: If Henry Schein, Inc. has DUNS 012430880 at parent level and 
                                        DUNS 830995189 at child level, this will render ONLY 830995189 here,
                                        matching the original document structure exactly.
                                        
                                        DO NOT use childOrg.Organization.Identifiers here - that contains ALL
                                        identifiers for the organization and would break the hierarchy.
                                    *@
                                    @if (childOrg.HasOrganizationIdentifiers)
                                    {
                                        foreach (var identifier in childOrg.OrganizationIdentifiers)
                                        {
                                            if (!string.IsNullOrWhiteSpace(identifier.IdentifierValue) &&
                                            !string.IsNullOrWhiteSpace(identifier.IdentifierSystemOID))
                                            {
                                                <id @SplTemplateHelpers.Attribute("extension", identifier.IdentifierValue) @SplTemplateHelpers.Attribute("root", identifier.IdentifierSystemOID) />
                                            }
                                        }
                                    }
                                    @* Child organization name *@
                                    <name>@childOrg.OrganizationName</name>
                                </assignedOrganization>
                                @* 
                                    Render business operations for this child organization.
                                    Each operation may reference multiple products via facility product links.
                                *@
                                @if (childOrg.HasBusinessOperations)
                                {
                                    foreach (var businessOp in childOrg.BusinessOperations)
                                    {
                                        @* Only render operations that have required codes and associated products *@
                                        @if (businessOp.HasOperationCode
                                                                && businessOp.HasOperationCodeSystem
                                                                && businessOp.HasProductLinks)
                                        {
                                            @* 
                                                Generate a separate performance element for each product link.
                                                This matches SPL specification where each product gets its own
                                                performance/actDefinition structure.
                                            *@
                                            foreach (var productLink in businessOp.ProductLinks)
                                            {
                                                <performance>
                                                    <actDefinition>
                                                        @* Render business operation code with display name if available *@
                                                        @if (businessOp.HasOperationDisplayName)
                                                        {
                                                            <code @SplTemplateHelpers.Attribute("code", businessOp.OperationCode) @SplTemplateHelpers.Attribute("codeSystem", businessOp.OperationCodeSystem) @SplTemplateHelpers.Attribute("displayName", businessOp.OperationDisplayName) />
                                                        }
                                                        else
                                                        {
                                                            <code @SplTemplateHelpers.Attribute("code", businessOp.OperationCode) @SplTemplateHelpers.Attribute("codeSystem", businessOp.OperationCodeSystem) />
                                                        }
                                                        @* 
                                                            Render product reference based on available identifier.
                                                            Preference order:
                                                            1. ProductName (typically NDC or CLN)
                                                            2. ProductIdentifierID (if ProductName is null)
                                                        *@
                                                        @if (!string.IsNullOrWhiteSpace(productLink.ProductName))
                                                        {
                                                            <product>
                                                                <manufacturedProduct classCode="MANU">
                                                                    <manufacturedMaterialKind>
                                                                        <code @SplTemplateHelpers.Attribute("code", productLink.ProductName) @SplTemplateHelpers.Attribute("codeSystem", productLink?.ProductIdentifier?.IdentifierSystemOID ?? "2.16.840.1.113883.6.69") />
                                                                    </manufacturedMaterialKind>
                                                                </manufacturedProduct>
                                                            </product>
                                                        }
                                                        else if (productLink.ProductIdentifierID.HasValue)
                                                        {
                                                            <product>
                                                                <manufacturedProduct classCode="MANU">
                                                                    <manufacturedMaterialKind>
                                                                        <code @SplTemplateHelpers.Attribute("code", productLink.ProductIdentifierID.Value.ToString()) @SplTemplateHelpers.Attribute("codeSystem", productLink?.ProductIdentifier?.IdentifierSystemOID ?? "2.16.840.1.113883.6.69") />
                                                                    </manufacturedMaterialKind>
                                                                </manufacturedProduct>
                                                            </product>
                                                        }
                                                    </actDefinition>
                                                </performance>
                                            }
                                        }
                                    }
                                }
                            </assignedEntity>
                        }
                    </assignedOrganization>
                </assignedEntity>
            }
        </representedOrganization>
    </assignedEntity>
</author>