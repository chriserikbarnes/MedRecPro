@using MedRecPro.Models;
@using RazorLight.Razor;
@inherits RazorLight.TemplatePage<MedRecPro.Models.StructuredBodyDto>;
@model StructuredBodyDto;
@{
    if (Model?.StructuredBodyView == null)
    {
        return;
    }

    var viewModel = Model.StructuredBodyView;

    // DIAGNOSTIC: Track section counts for duplication analysis
    var sectionCount = viewModel.AllSectionContexts?.Count ?? 0;
    var sectionIds = viewModel.AllSectionContexts != null
        ? string.Join(",", viewModel.AllSectionContexts.Where(s => s.Section?.SectionID != null).Select(s => s.Section.SectionID))
        : "none";
}
<!-- DUPLICATION_DIAG: StructuredBody rendering AllSectionContexts count=@sectionCount, SectionIDs=[@sectionIds] -->
<structuredBody>
    @foreach (var context in viewModel.AllSectionContexts)
    {
        var sectionDtoHash = context.Section?.GetHashCode() ?? 0;
        var sectionRenderingHash = context.GetHashCode();
        var renderedTextCount = context.RenderedTextContent?.Count ?? 0;
        <!-- DUPLICATION_DIAG: Rendering section ID=@(context.Section?.SectionID), Code=@(context.Section?.SectionCode ?? "null"), IsStandalone=@context.IsStandalone, SectionDtoHash=@sectionDtoHash, SectionRenderingHash=@sectionRenderingHash, RenderedTextCount=@renderedTextCount -->
        <component>
            @{
                await IncludeAsync("_Section", context);
            }
        </component>
    }
</structuredBody>