@using RazorLight.Razor;
@using MedRecPro.Models;
@using MedRecPro.Helpers;
@using MedRecPro.Service;
@inherits RazorLight.TemplatePage<MedRecPro.Models.ProductRendering>;
@model ProductRendering;

@* Clean template with proper fallback logic *@
@if (Model != null)
{
    var productModel = Model.ProductDto;
    <subject>
        <manufacturedProduct>
            <manufacturedProduct>

                @* Render NDC identifier if available *@
                @if (Model.HasNdcIdentifier && Model.NdcProductIdentifier != null)
                {
                    <code @SplTemplateHelpers.Attribute("code", Model.NdcProductIdentifier.IdentifierValue) @SplTemplateHelpers.Attribute("codeSystem", Model.NdcProductIdentifier.IdentifierSystemOID) />
                }

                <name>@productModel.ProductName</name>
                <formCode @SplTemplateHelpers.Attribute("code", productModel.FormCode) @SplTemplateHelpers.Attribute("codeSystem", productModel.FormCodeSystem) @SplTemplateHelpers.Attribute("displayName", productModel.FormDisplayName) />

                @* Render equivalent entities if available - must come BEFORE asEntityWithGeneric per SPL schema *@
                @if (Model.HasEquivalentEntities && Model.OrderedEquivalentEntities != null)
                {
                    foreach (var equivalentEntity in Model.OrderedEquivalentEntities)
                    {
                        <asEquivalentEntity @SplTemplateHelpers.Attribute("classCode", Constant.EQUIVALENCE_CLASS_CODE)>
                            @if (!string.IsNullOrWhiteSpace(equivalentEntity.EquivalenceCode))
                            {
                                <code @SplTemplateHelpers.Attribute("code", equivalentEntity.EquivalenceCode) @SplTemplateHelpers.Attribute("codeSystem", equivalentEntity.EquivalenceCodeSystem) />
                            }
                            @if (!string.IsNullOrWhiteSpace(equivalentEntity.DefiningMaterialKindCode))
                            {
                                <definingMaterialKind>
                                    <code @SplTemplateHelpers.Attribute("code", equivalentEntity.DefiningMaterialKindCode) @SplTemplateHelpers.Attribute("codeSystem", equivalentEntity.DefiningMaterialKindSystem) />
                                </definingMaterialKind>
                            }
                        </asEquivalentEntity>
                    }
                }

                @* Render generic medicines if available - must come AFTER asEquivalentEntity per SPL schema *@
                @if (Model.HasGenericMedicines && productModel.GenericMedicines != null)
                {
                    foreach (var generic in productModel.GenericMedicines)
                    {
                        <asEntityWithGeneric>
                            <genericMedicine>
                                <name>@generic.GenericName</name>
                            </genericMedicine>
                        </asEntityWithGeneric>
                    }
                }

                @* For non-Kit products: Render ingredients directly on the product *@
                @if (!Model.IsKit)
                {
                    @* Render active ingredients if available *@
                    if (Model.HasActiveIngredients && Model.ActiveIngredients != null)
                    {
                        foreach (var ingredient in Model.ActiveIngredients)
                        {
                            await IncludeAsync("_Ingredient", ingredient);
                        }
                    }

                    @* Render inactive ingredients if available *@
                    if (Model.HasInactiveIngredients && Model.InactiveIngredients != null)
                    {
                        foreach (var ingredient in Model.InactiveIngredients)
                        {
                            await IncludeAsync("_Ingredient", ingredient);
                        }
                    }
                }

                @* Render top-level packaging if available *@
                @if (Model.HasPackageRendering && Model.PackageRendering != null)
                {
                    foreach (var packageRendering in Model.PackageRendering)
                    {
                        await IncludeAsync("_Packaging", packageRendering);
                    }
                }

                @* For Kit products: Render parts with their own ingredients, characteristics, etc. *@
                @if (Model.IsKit && Model.HasProductParts && Model.ProductParts != null)
                {
                    foreach (var part in Model.ProductParts)
                    {
                        await IncludeAsync("_ProductPart", part);
                    }
                }

            </manufacturedProduct>

            @* Render marketing status if available. This is for the aprroval information *@
            @if (Model.HasMarketingStatus && Model.OrderedMarketingCategories != null)
            {
                foreach (var marketingCategory in Model.OrderedMarketingCategories)
                {
                    <subjectOf>
                        @{
                            await IncludeAsync("_MarketingStatus", marketingCategory);
                        }
                    </subjectOf>
                }
            }
            else if (Model.HasPrimaryMarketingCategory && Model.PrimaryMarketingCategory != null)
            {
                @* Render single marketing status for simplified scenarios *@  
                 <subjectOf>
                    @{
                        await IncludeAsync("_MarketingStatus", Model.PrimaryMarketingCategory);
                    }
                </subjectOf>
            }

            @* Render product-level marketing act if available - ONLY ONE per specification 3.1.8.2 *@
            @if (Model.HasMarketingAct && Model.OrderedMarketingStatuses != null && Model.OrderedMarketingStatuses.Count == 1)
            {
                var marketingStatus = Model.OrderedMarketingStatuses.First();
                <subjectOf>
                    <marketingAct>
                        <code @SplTemplateHelpers.Attribute("code", marketingStatus.MarketingActCode) @SplTemplateHelpers.Attribute("codeSystem", marketingStatus.MarketingActCodeSystem) />
                        <statusCode @SplTemplateHelpers.Attribute("code", marketingStatus.StatusCode) />
                        <effectiveTime>
                            @if (marketingStatus.EffectiveStartDate.HasValue)
                            {
                                <low @SplTemplateHelpers.Attribute("value", SplTemplateHelpers.ToSplDate(marketingStatus.EffectiveStartDate)) />
                            }
                            @if (marketingStatus.EffectiveEndDate.HasValue)
                            {
                                <high @SplTemplateHelpers.Attribute("value", SplTemplateHelpers.ToSplDate(marketingStatus.EffectiveEndDate)) />
                            }
                        </effectiveTime>
                    </marketingAct>
                </subjectOf>
            }

            @* Redener product policy information e.g. classCode="DEADrugSchedule"*@
            @if (Model.HasPolicy && Model.OrderedPolicies != null)
            {
                @* Use enhanced policy rendering *@
                foreach (var policy in Model.OrderedPolicies)
                {
                    <subjectOf>
                        <policy @SplTemplateHelpers.Attribute("classCode", policy.PolicyClassCode)>
                            <code @SplTemplateHelpers.Attribute("code", policy.PolicyCode) @SplTemplateHelpers.Attribute("codeSystem", policy.PolicyCodeSystem) @SplTemplateHelpers.Attribute("displayName", policy.PolicyDisplayName) />
                        </policy>
                    </subjectOf>
                }
            }

            @* Render characteristics with proper fallback logic *@
            @if (Model.HasCharacteristicRendering && Model.CharacteristicRendering != null)
            {
                @* Use enhanced characteristic rendering *@
                foreach (var characteristicRendering in Model.CharacteristicRendering)
                {
                    <subjectOf>
                        @{
                            await IncludeAsync("_Characteristic", characteristicRendering);
                        }
                    </subjectOf>
                }
            }
            else if (Model.HasCharacteristics && Model.OrderedCharacteristics != null)
            {

                var characteristicService = new CharacteristicRenderingService();

                foreach (var characteristic in Model.OrderedCharacteristics)
                {

                    var enhancedCharacteristic = characteristicService.PrepareForRendering(characteristic);

                    <subjectOf>
                        @{
                            await IncludeAsync("_Characteristic", enhancedCharacteristic);
                        }
                    </subjectOf>
                }
            }

            @* Render routes if available *@
            @if (Model.HasRoutes && Model.OrderedRoutes != null)
            {
                foreach (var route in Model.OrderedRoutes)
                {
                    <consumedIn>
                        <substanceAdministration>
                            <routeCode @SplTemplateHelpers.Attribute("code", route?.RouteCode) @SplTemplateHelpers.Attribute("codeSystem", route?.RouteCodeSystem) @SplTemplateHelpers.Attribute("displayName", route?.RouteDisplayName) />
                        </substanceAdministration>
                    </consumedIn>
                }
            }
        </manufacturedProduct>
    </subject>
}