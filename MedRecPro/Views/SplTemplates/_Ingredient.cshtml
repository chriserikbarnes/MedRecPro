@using MedRecPro.Models;
@using MedRecPro.Helpers;
@inherits RazorLight.TemplatePage<MedRecPro.Models.IngredientRendering>;
@model IngredientRendering;

@* Clean template with no business logic *@
@if (Model != null)
{
    var ingredient = Model.IngredientDto;

    @if (Model.IsActiveIngredient)
    {
        <ingredient @Raw(Model.ClassCodeAttribute)>
            @if (Model.HasQuantity)
            {
                <quantity>
                    <numerator @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityNumerator) @SplTemplateHelpers.Attribute("unit", ingredient.QuantityNumeratorUnit)>
                        @if (Model.HasNumeratorTranslation)
                        {
                            <translation @SplTemplateHelpers.Attribute("code", ingredient.NumeratorTranslationCode) @SplTemplateHelpers.Attribute("codeSystem", ingredient.NumeratorCodeSystem) @SplTemplateHelpers.Attribute("displayName", ingredient.NumeratorDisplayName) @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityNumerator) />
                        }
                    </numerator>
                    <denominator @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityDenominator) @SplTemplateHelpers.Attribute("unit", ingredient.QuantityDenominatorUnit)>
                        @if (Model.HasDenominatorTranslation)
                        {
                            <translation @SplTemplateHelpers.Attribute("code", ingredient.DenominatorTranslationCode) @SplTemplateHelpers.Attribute("codeSystem", ingredient.DenominatorCodeSystem) @SplTemplateHelpers.Attribute("displayName", ingredient.DenominatorDisplayName) @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityDenominator) />
                        }
                    </denominator>
                </quantity>
            }

            <ingredientSubstance>
                @if (Model.HasSpecifiedSubstances && Model.OrderedSpecifiedSubstances != null)
                {
                    foreach (var substance in Model.OrderedSpecifiedSubstances)
                    {
                        <code @SplTemplateHelpers.Attribute("code", substance.SubstanceCode) @SplTemplateHelpers.Attribute("codeSystem", substance.SubstanceCodeSystem) @SplTemplateHelpers.Attribute("codeSystemName", substance.SubstanceCodeSystemName) />
                    }
                }
                else if (Model.HasSubstance && Model.HasUniiCode)
                {
                    @* Fallback to UNII from ingredient substance if no specified substances *@
                    <code @SplTemplateHelpers.Attribute("code", Model.UniiCode) @SplTemplateHelpers.Attribute("codeSystem", Model.FdaSrsCodeSystem) @SplTemplateHelpers.Attribute("codeSystemName", Model.FdaSrsCodeSystemName) />
                }

                <name>@Model.FormattedSubstanceName</name>

                @if (Model.HasActiveMoieties && Model.OrderedActiveMoieties != null)
                {

                    @foreach (var moiety in Model.OrderedActiveMoieties)
                    {
                        <activeMoiety>
                            <activeMoiety>
                                @if (!string.IsNullOrEmpty(moiety.MoietyUNII))
                                {
                                    <code @SplTemplateHelpers.Attribute("code", moiety.MoietyUNII) @SplTemplateHelpers.Attribute("codeSystem", Model.FdaSrsCodeSystem) />
                                }
                                <name>@(moiety.MoietyName ?? "")</name>
                            </activeMoiety>
                        </activeMoiety>
                    }
                }

                @* Render asEquivalentSubstance for ACTIR ingredients *@
                @if (Model.RequiresReferenceSubstance && Model.PrimaryReferenceSubstance != null)
                {
                    <asEquivalentSubstance>
                        <definingSubstance>
                            <code @SplTemplateHelpers.Attribute("code", Model.PrimaryReferenceSubstance.RefSubstanceUNII) @SplTemplateHelpers.Attribute("codeSystem", Model.FdaSrsCodeSystem) />
                            <name>@(Model.PrimaryReferenceSubstance.RefSubstanceName ?? "")</name>
                        </definingSubstance>
                    </asEquivalentSubstance>
                }
            </ingredientSubstance>
        </ingredient>
    }
    else
    {
        <ingredient @Raw(Model.ClassCodeAttribute)>
            @if (Model.HasQuantity)
            {
                <quantity>
                    <numerator @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityNumerator) @SplTemplateHelpers.Attribute("unit", ingredient.QuantityNumeratorUnit)>
                        @if (Model.HasNumeratorTranslation)
                        {
                            <translation @SplTemplateHelpers.Attribute("code", ingredient.NumeratorTranslationCode) @SplTemplateHelpers.Attribute("codeSystem", ingredient.NumeratorCodeSystem) @SplTemplateHelpers.Attribute("displayName", ingredient.NumeratorDisplayName) @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityNumerator) />
                        }
                    </numerator>
                    <denominator @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityDenominator) @SplTemplateHelpers.Attribute("unit", ingredient.QuantityDenominatorUnit)>
                        @if (Model.HasDenominatorTranslation)
                        {
                            <translation @SplTemplateHelpers.Attribute("code", ingredient.DenominatorTranslationCode) @SplTemplateHelpers.Attribute("codeSystem", ingredient.DenominatorCodeSystem) @SplTemplateHelpers.Attribute("displayName", ingredient.DenominatorDisplayName) @SplTemplateHelpers.Attribute("value", Model.FormattedQuantityDenominator) />
                        }
                    </denominator>
                </quantity>
            }
            <ingredientSubstance>
                @if (Model.HasSpecifiedSubstances && Model.OrderedSpecifiedSubstances != null)
                {
                    foreach (var substance in Model.OrderedSpecifiedSubstances)
                    {
                        <code @SplTemplateHelpers.Attribute("code", substance.SubstanceCode) @SplTemplateHelpers.Attribute("codeSystem", substance.SubstanceCodeSystem) @SplTemplateHelpers.Attribute("codeSystemName", substance.SubstanceCodeSystemName) />
                    }
                }
                else if (Model.HasSubstance && Model.HasUniiCode)
                {
                    @* Fallback to UNII from ingredient substance for inactive ingredients *@
                    <code @SplTemplateHelpers.Attribute("code", Model.UniiCode) @SplTemplateHelpers.Attribute("codeSystem", Model.FdaSrsCodeSystem) @SplTemplateHelpers.Attribute("codeSystemName", Model.FdaSrsCodeSystemName) />
                }
                <name>@Model.FormattedSubstanceName</name>
            </ingredientSubstance>
        </ingredient>
    }
}