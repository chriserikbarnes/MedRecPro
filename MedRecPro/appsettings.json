{
  "Version": "0.1.15-alpha",

  "StaticSiteDevPort": 5001,

  "RazorLight": {
    "TemplateFolder": "Views",
    "CachingEnabled": true,
    "DefaultNamespaces": [
      "System",
      "System.Collections.Generic",
      "System.Linq",
      "YourApp.Models"
    ]
  },

  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },

  // ============================================================================
  // IN-MEMORY LOGGING SETTINGS
  // ============================================================================
  /*
      Configuration for the in-memory log storage system used by UserLoggerProvider.
      These logs are accessible via the /api/settings/logs/* endpoints (Admin only).

      Key Settings:
      - RetentionMinutes: How long to keep log entries before automatic cleanup.
      - MaxEntriesPerCategory: Maximum entries per logger category (e.g., per controller).
      - MaxTotalEntries: Maximum total entries across all categories.
      - CaptureUserContext: Whether to capture authenticated user info with each log entry.

      Performance Notes:
      - Cleanup runs at most every 30 seconds to minimize overhead.
      - User context capture is fail-safe and non-blocking.
      - Memory usage is bounded by MaxTotalEntries × average entry size.
  */
  "LoggingSettings": {
    // Maximum time in minutes to retain log entries (default: 60)
    "RetentionMinutes": 60,

    // Maximum entries per logger category (default: 10000)
    "MaxEntriesPerCategory": 10000,

    // Maximum total entries across all categories (default: 50000)
    "MaxTotalEntries": 50000,

    // Whether to capture user identity with log entries (default: true)
    "CaptureUserContext": true
  },

  // ============================================================================
  // AI CONFIGURATION
  // ============================================================================
  /*
      This configuration section defines settings for integrating with the Anthropic Claude API.
      Items that define skill paths should point to markdown files that contain the prompt templates. 
      These values are referenced within configuration calls and CHANGING THE KEY here will BREAK those calls.
    
        Key Settings:
        - Skill-Label: Path to the markdown file defining the labeling skill prompt.
        - Model: The Claude model version to use (e.g., "claude-sonnet-4-20250514").
        - MaxTokens: Maximum tokens allowed in the response.
        - BaseUrl: The base URL for the Anthropic API endpoint.
        - AnthropicVersion: API version date.
        - TimeoutSeconds: Request timeout duration in seconds.
        - Temperature: Controls randomness in responses (0.0 = deterministic, 1.0 = creative).
        - Thinking: Configuration for enabling "thinking" mode with a token budget.
    */
  "ClaudeApiSettings": {
    "Skill-Label": "skills/label.md",
    "Skill-Section": "skills/labelSection.md",
    "Skill-Synthesis": "skills/synthesisPrompt.md",
    "Skill-Retry": "skills/retryPrompt.md",
    "Skill-Settings": "skills/settings.md",
    "Skill-UserActivity": "skills/useractivity.md",
    "Model": "claude-sonnet-4-20250514",
    "MaxTokens": 8000,
    "BaseUrl": "https://api.anthropic.com/v1/messages",
    "AnthropicVersion": "2023-06-01",
    "TimeoutSeconds": 120,
    "Temperature": 0.1,
    "Thinking": {
      "type": "enabled",
      "budget_tokens": 16000
    }
  },

  "ComparisonSettings": {
    "SaveReports": true,
    "MaxPromptLength": 500000,
    "EnableCaching": true,
    "CacheExpirationHours": 24,
    "MaxFileSize": 10485760,
    "SupportedFormats": [ "xml", "json" ],
    "RetryAttempts": 3,
    "RetryDelaySeconds": 5
  },

  "FileStorageSettings": {
    "BasePath": "uploads",
    "MaxRetentionDays": 30,
    "EnableCompression": true
  },

  "TemplateSettings": {
    "XmlTemplatePath": "Templates/spl-template-conditional.xml"
  },

  "Azure": {
    "SqlDatabase": {
      "MetricsRegion": "eastus"
    }
  },

  "Authentication": {
    "Microsoft": {
      "Instance": "https://login.microsoftonline.com/",
      "CallbackPath": "/signin-microsoft",
      "SignedOutCallbackPath": "/signout-callback-oidc"
    }
  },
  // ============================================================================
  // DATABASE USAGE MONITOR CONFIGURATION
  // ============================================================================

  "DatabaseUsageMonitor": {
    // -------------------------------------------------------------------------
    // Service Settings
    // -------------------------------------------------------------------------

    // Whether the background monitoring service is enabled
    "Enabled": true,

    // How often to poll Azure Monitor for metrics (in hours)
    // Minimum: 0.5 (30 minutes), Recommended: 2-4 hours
    "PollingIntervalHours": 2,

    // Delay before first poll after application startup (in seconds)
    "InitialDelaySeconds": 60,

    // Number of consecutive failures before marking monitoring as inactive
    "MaxConsecutiveFailures": 5,

    // -------------------------------------------------------------------------
    // Throttle Level Thresholds (percent of free tier consumed)
    // -------------------------------------------------------------------------

    // Warning level: Consider reducing non-essential operations
    "WarningThreshold": 250,

    // Moderate level: Rate-limit non-critical operations
    "ModerateThreshold": 350,

    // Aggressive level: Only essential operations should proceed without delay
    "AggressiveThreshold": 400,

    // Critical level: Block all non-essential operations
    "CriticalThreshold": 450,

    // -------------------------------------------------------------------------
    // Cost Limit Settings
    // -------------------------------------------------------------------------

    // Maximum monthly usage as percent of free tier before CostLimit activates
    // 100 = stop at free tier boundary (no paid usage)
    // 110 = allow 10% overage (~$1.45 max cost)
    // 150 = allow 50% overage (~$7.25 max cost)
    // 200 = allow 100% overage (~$14.50 max cost)
    // 300 = allow 200% overage (~$29.00 max cost)
    // 400 = allow 300% overage (~$43.50 max cost)
    // 500 = allow 400% overage (~$58.00 max cost)
    // Note: Each 10% overage ≈ $1.45 additional cost
    // 
    // Formula: Max cost = (MaxMonthlyCostPercent - 100) × 1000 × $0.000145
    // 
    // Default: 110 (allows ~$1.45/month overage)
    "MaxMonthlyCostPercent": 500

    // ============================================================================
    // THROTTLE LEVEL REFERENCE
    // ============================================================================
    //
    // | Level      | Default % | [DatabaseIntensive] | [DatabaseLimit] Delay |
    // |------------|-----------|---------------------|------------------------|
    // | None       | < 70%     | No effect           | No delay               |
    // | Warning    | 70-80%    | No effect           | 1x base delay          |
    // | Moderate   | 80-90%    | Block NonCritical   | 2x base delay          |
    // | Aggressive | 90-95%    | Block Normal+       | 4x base delay          |
    // | Critical   | 95-100%   | Block most          | 8x base delay          |
    // | CostLimit  | > 110%    | Block all except    | 16x base delay         |
    // |            |           | Critical ops        |                        |
    //
    // ============================================================================
    // COST ESTIMATION TABLE
    // ============================================================================
    //
    // | MaxMonthlyCostPercent | Overage (vCore-sec) | Max Monthly Cost |
    // |-----------------------|---------------------|------------------|
    // | 100                   | 0                   | $0.00            |
    // | 110                   | 10,000              | ~$1.45           |
    // | 125                   | 25,000              | ~$3.63           |
    // | 150                   | 50,000              | ~$7.25           |
    // | 200                   | 100,000             | ~$14.50          |
    // | 300                   | 200,000             | ~$29.00          |
    // | 400                   | 300,000             | ~$43.50          |
    // | 500                   | 400,000             | ~$58.00          |
    //
    // ============================================================================

  },

  /*
  
Configuration Options
---------------------
Enabled (bool)
  Default: false
  Description: Master switch to enable/disable demo mode
  Usage: Set to true to activate the service

RefreshIntervalMinutes (int)
  Default: 60
  Description: How often (in minutes) to execute database truncation
  Usage: Adjust based on your demo needs (e.g., 30 for every 30 minutes, 1440 for daily)

AutoTruncateOnStartup (bool)
  Default: false
  Description: Whether to execute an immediate truncation when the service starts
  Usage: Set to true if you want a clean database on every application restart

PreserveTables (array of strings)
  Default: AspNet tables, migrations history, and activity log
  Description: List of tables that should NOT be truncated
  Usage: Add any additional tables you want to preserve

EnableScheduledTruncation (bool)
  Default: true
  Description: Whether to run scheduled truncations (independent of other demo features)
  Usage: Set to false to disable automatic truncation while keeping other demo mode features active

ShowDemoModeBanner (bool)
  Default: true
  Description: Flag for UI to display demo mode banner
  Usage: Can be checked in your views/controllers to show a banner to users

Examples:

Development/Testing Environment:
---------------------
"DemoModeSettings": {
    "Enabled": true,
    "RefreshIntervalMinutes": 30,
    "AutoTruncateOnStartup": true
  }

Public Demo Environment
---------------------
"DemoModeSettings": {
  "Enabled": true,
  "RefreshIntervalMinutes": 60,
  "AutoTruncateOnStartup": false,
  "ShowDemoModeBanner": true
}

Production Environment
---------------------
"DemoModeSettings": {
  "Enabled": false
}
  
*/
  "DemoModeSettings": {
    "Enabled": true,
    "RefreshIntervalMinutes": 1440, // once daily
    "AutoTruncateOnStartup": false,
    "PreserveTables": [
      "__EFMigrationsHistory",
      "AspNetUsers",
      "AspNetRoles",
      "AspNetUserRoles",
      "AspNetUserClaims",
      "AspNetRoleClaims",
      "AspNetUserLogins",
      "AspNetUserTokens",
      "AspNetUserActivityLog"
    ],
    "EnableScheduledTruncation": true,
    "ShowDemoModeBanner": true
  },
  /*

Available Feature Flags
---------------------
ExternalAuthEnabled
  Type: bool
  Default: true
  Purpose: Controls external OAuth authentication providers (Google, Microsoft, etc.)
  When disabled:
    External login endpoints return appropriate error messages
    Only internal authentication (username/password) is available
    OAuth configuration is not loaded
  Use cases:
    Maintenance mode
    Internal-only deployments
    Security lockdown scenarios
--------------------
SplImportEnabled
  Type: bool
  Default: true
  Purpose: Controls SPL XML import functionality from ZIP files
  When disabled:
    Import endpoints return "feature disabled" responses
    Upload UI components can be hidden
    Background import processing is skipped
  Use cases:
    Demo environments (prevent data pollution)
    Read-only deployments
    Maintenance windows
--------------------
SplExportEnabled
  Type: bool
  Default: true
  Purpose: Controls SPL XML export and generation functionality
  When disabled:
    Export endpoints return "feature disabled" responses
    Download buttons can be hidden in UI
    XML generation is prevented
  Use cases:
    Data protection scenarios
    Limited-access deployments
    Troubleshooting export issues
--------------------
ComparisonAnalysisEnabled
  Type: bool
  Default: true
  Purpose: Controls document comparison and analysis against FDA templates
  When disabled:
    Analysis endpoints return "feature disabled" responses
    Comparison UI features can be hidden
    Background analysis jobs are not queued
  Use cases:
    Performance optimization (analysis is resource-intensive)
    Demo environments
    Deployments without Claude API access
--------------------
BackgroundProcessingEnabled
  Type: bool
  Default: true
  Purpose: Controls all background task processing (imports, analysis, long-running operations)
  When disabled:
    Background queue service is not started
    Operations that normally run async will fail gracefully
    Status polling endpoints return appropriate messages
  Use cases:
    Single-threaded debugging
    Resource-constrained environments
    Troubleshooting async issues
  ⚠️ Warning: Disabling this will significantly impact user experience for long-running operations.
--------------------
ActivityTrackingEnabled
  Type: bool
  Default: true
  Purpose: Controls user activity logging and audit trail
  When disabled:
    Activity logs are not written to database
    Activity endpoints return empty results
    Performance slight improvement (no logging overhead)
  Use cases:
    Privacy-focused deployments
    Performance optimization
    Testing scenarios
  ⚠️ Warning: Disabling this removes audit trail capabilities.
--------------------
UseBulkOperations
  Type: bool
  Default: false
  Purpose: Controls database operation strategy for parsing and import operations
  When enabled:
    Database operations use bulk insert/update patterns
    Single database roundtrips replace N+1 query patterns
    Significant performance improvement for SPL parsing (200+ queries → 6-10 queries per document)
    Optimized for ingredient parsing, section processing, and organization handling
  When disabled:
    Traditional N+1 query pattern is used
    Multiple database roundtrips per entity
    Legacy behavior maintained for compatibility
  Use cases:
    Production environments (recommended)
    High-volume SPL processing
    Azure SQL deployments (minimizes DTU consumption)
    Performance optimization scenarios
  ⚠️ Warning: Enable this flag for production use. The N+1 pattern can cause severe performance 
     degradation with Azure SQL Database, especially during bulk imports.
--------------------
UseBulkStagingOperations
Type: bool
Default: false
Purpose: Controls staged bulk operations for section processing
When enabled:
  Section discovery happens first (single XML traversal to memory)
  All sections across all nesting levels processed in flat bulk operations
  Eliminates recursive orchestration causing nested database operations
  Reduces database operations from 200+ to ~15-20 for typical documents
  Significant performance improvement (5-6× faster than nested bulk)
When disabled:
  Falls back to nested bulk operations (if UseBulkOperations enabled)
  Or N+1 pattern (if UseBulkOperations also disabled)
⚠️ Requires: UseBulkOperations must also be enabled
Use cases:
  Production environments with large SPL documents (100+ sections)
  Azure SQL deployments requiring minimal database round-trips
⚠️ Warning: Advanced optimization. Test thoroughly before enabling.
Three modes of operation:
  1. UseBulkStaging=true: Staged bulk (discovery + flat processing)
  2. UseBulkOperations=true: Nested bulk (contains section recursion)
  3. Both false: N+1 pattern (legacy compatibility)
--------------------
UseEnhancedDebugging
  Type: bool
  Default: false
  Purpose: Controls verbose debug output in Visual Studio debug window
  When enabled:
    Detailed parsing step information logged
    Database operation timing and query counts displayed
    XML transformation steps tracked
    Enhanced error context provided
    Additional performance metrics captured
  When disabled:
    Standard logging level maintained
    Minimal debug output
    Production-appropriate logging
  Use cases:
    Local development and troubleshooting
    Performance analysis and optimization
    Debugging parsing or database issues
    Investigating XML rendering problems
  ⚠️ Note: Keep disabled in production. Enhanced debugging generates significant log volume 
     and may impact performance.
--------------------
UseBatchSaving
  Type: bool
  Default: true
  Purpose: Controls database save strategy by deferring all save operations to orchestrator level
  When enabled:
    Parser helpers accumulate changes in memory without saving
    Orchestrator performs single batch save after all parsing completes
    Minimizes database transaction overhead and locking
    Optimizes EF Core change tracking and DetectChanges() calls
    Reduces database round-trips regardless of bulk operations setting
  When disabled:
    Parser helpers save entities incrementally during parsing
    Multiple database transactions throughout parsing process
    Legacy save-as-you-parse behavior maintained
    Useful for debugging (see changes immediately after each parse step)
  Use cases:
    Production environments (recommended)
    High-volume SPL processing
    Minimizing database transaction duration
    Reducing DTU consumption in Azure SQL
  ⚠️ Relationship to UseBulkOperations:
     These flags are complementary. UseBatchSaving controls WHEN saves occur (deferred to end),
     while UseBulkOperations controls HOW entities are inserted (bulk vs N+1).
     Both should be enabled together for optimal performance.
  ⚠️ Debugging consideration:
     Disable this flag when debugging parsing logic to see database state after each parsing 
     step. With this enabled, database remains empty until orchestrator completes, making 
     step-by-step debugging more difficult.
  Performance impact:
    Reduces transaction count from dozens per document to 1-2 per document
    Eliminates intermediate SaveChanges() calls and their overhead
    Allows EF Core to optimize change tracking across entire parse operation
--------------------
  */

  "FeatureFlags": {
    "ExternalAuthEnabled": true,
    "SplImportEnabled": true,
    "SplExportEnabled": true,
    "ComparisonAnalysisEnabled": true,
    "BackgroundProcessingEnabled": true,
    "ActivityTrackingEnabled": true,
    "UseBulkOperations": false,
    "UseBulkStagingOperations": true,
    "UseBatchSaving": true,
    "UseEnhancedDebugging": false
  },
  "AuthenticationSettings": {
    "PostLoginRedirectPath": "/swagger/index.html"
  },
  "KeyVaultUrl": "https://medrecprovault.vault.azure.net/",
  "AllowedHosts": "*",
  "UserCookie": "MedRecProUser",
  "AuthenticationTimeout": 60,
  "IgnoreEmptyObjectsWhenSerializing": true // Set to False when you want to include empty objects in the JSON serialization
}
